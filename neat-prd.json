{
  "name": "NEAT Implementation",
  "version": "1.0",
  "goal": "Implement NEAT (NeuroEvolution of Augmenting Topologies) for topology evolution",
  "prerequisite": "Speciation (Phase 10) must be complete - NEAT reuses speciation infrastructure",
  "reference": "docs/NEAT.md",
  "decisions": {
    "initial_topology": "Option B - input→output fully connected (per NEAT paper)",
    "recurrent_connections": "Phase 2 (feedforward only in Phase 1)",
    "node_deletion": "No deletion (follow paper - disabled genes can re-enable)",
    "speciation": "Reuse existing with pluggable distance_fn parameter",
    "fitness_sharing": "Auto-disable when NEAT enabled (redundant with speciation)",
    "batching": "Per-creature forward pass first, optimize to batched later if needed",
    "innovation_scope": "Per-run (simpler, allows parallel runs)"
  },
  "phase_1": {
    "name": "Feedforward NEAT",
    "status": "pending",
    "goal": "Complete working NEAT with feedforward networks only",
    "tasks": {
      "backend_schemas": {
        "id": "1.1",
        "name": "NEAT Genome Schemas",
        "status": "complete",
        "file": "backend/app/schemas/neat.py",
        "new_file": true,
        "description": "Define NodeGene, ConnectionGene, NEATGenome Pydantic models",
        "details": {
          "NodeGene": "id, type (input/hidden/output), bias, innovation (None for I/O)",
          "ConnectionGene": "from_node, to_node, weight, enabled, innovation",
          "NEATGenome": "nodes list, connections list, activation"
        }
      },
      "backend_network": {
        "id": "1.2",
        "name": "NEAT Network Execution",
        "status": "complete",
        "file": "backend/app/neural/neat_network.py",
        "new_file": true,
        "description": "Forward pass and genome creation",
        "functions": [
          "create_minimal_neat_genome(input_size, output_size, output_bias) - Option B topology",
          "topological_sort(genome) - compute evaluation order",
          "neat_forward(genome, inputs) - single genome forward pass",
          "would_create_cycle(genome, from_id, to_id) - cycle detection"
        ]
      },
      "backend_mutation": {
        "id": "1.3",
        "name": "Structural Mutations",
        "status": "complete",
        "file": "backend/app/genetics/neat_mutation.py",
        "new_file": true,
        "description": "NEAT structural mutation operators",
        "functions": [
          "mutate_add_connection(genome, innovation_counter) - add new connection",
          "mutate_add_node(genome, innovation_counter) - split connection with new node",
          "mutate_toggle_connection(genome) - enable/disable random connection",
          "mutate_neat_weights(genome, rate, magnitude) - weight perturbation",
          "get_connection_innovation(counter, from_node, to_node) - innovation tracking",
          "get_node_innovation(counter, split_connection_id) - innovation tracking"
        ]
      },
      "backend_crossover": {
        "id": "1.4",
        "name": "NEAT Crossover",
        "status": "complete",
        "file": "backend/app/genetics/neat_crossover.py",
        "new_file": true,
        "description": "Gene alignment and crossover by innovation ID",
        "functions": [
          "align_genes(parent_a, parent_b) - align by innovation ID",
          "neat_crossover(parent_a, parent_b, fitness_a, fitness_b) - NEAT crossover"
        ],
        "rules": [
          "Matching genes: random from either parent",
          "Disjoint/excess genes: from fitter parent",
          "Disabled gene: 75% chance stays disabled in child"
        ]
      },
      "backend_distance": {
        "id": "1.5",
        "name": "Compatibility Distance",
        "status": "complete",
        "file": "backend/app/genetics/neat_distance.py",
        "new_file": true,
        "description": "NEAT genome distance for speciation",
        "formula": "δ = (c1 × E / N) + (c2 × D / N) + (c3 × W̄)",
        "variables": {
          "E": "excess genes",
          "D": "disjoint genes",
          "N": "genes in larger genome",
          "W̄": "avg weight diff of matching genes"
        }
      },
      "backend_speciation_update": {
        "id": "1.6",
        "name": "Speciation Distance Function",
        "status": "complete",
        "file": "backend/app/genetics/speciation.py",
        "new_file": false,
        "description": "Add distance_fn parameter to assign_species()",
        "change": "assign_species(genomes, fitness_scores, threshold, distance_fn=neural_genome_distance)"
      },
      "backend_mutation_integration": {
        "id": "1.7",
        "name": "Mutation Integration",
        "status": "complete",
        "file": "backend/app/genetics/mutation.py",
        "new_file": false,
        "description": "Route to NEAT mutations when use_neat=True",
        "change": "In mutate_genome(): if config.use_neat, use mutate_neat_genome()"
      },
      "backend_crossover_integration": {
        "id": "1.8",
        "name": "Crossover Integration",
        "status": "complete",
        "file": "backend/app/genetics/crossover.py",
        "new_file": false,
        "description": "Route to NEAT crossover when use_neat=True",
        "change": "In crossover_genomes(): if config.use_neat, use neat_crossover()"
      },
      "backend_population_integration": {
        "id": "1.9",
        "name": "Population Integration",
        "status": "complete",
        "file": "backend/app/genetics/population.py",
        "new_file": false,
        "description": "Add NEAT config, track innovation counter, use neat_genome_distance for speciation"
      },
      "backend_genetics_schema": {
        "id": "1.10",
        "name": "Genetics Config Schema",
        "status": "pending",
        "file": "backend/app/schemas/genetics.py",
        "new_file": false,
        "description": "Add NEAT fields to EvolutionConfig",
        "fields": [
          "use_neat: bool = False",
          "add_connection_rate: float = 0.05",
          "add_node_rate: float = 0.03",
          "neat_excess_coefficient: float = 1.0",
          "neat_disjoint_coefficient: float = 1.0",
          "neat_weight_coefficient: float = 0.4",
          "max_hidden_nodes: int = 16"
        ]
      },
      "backend_simulation_schema": {
        "id": "1.11",
        "name": "Simulation Config Schema",
        "status": "pending",
        "file": "backend/app/schemas/simulation.py",
        "new_file": false,
        "description": "Add same NEAT fields to SimulationConfig"
      },
      "backend_simulator": {
        "id": "1.12",
        "name": "Simulator NEAT Support",
        "status": "pending",
        "file": "backend/app/services/pytorch_simulator.py",
        "new_file": false,
        "description": "Detect NEAT genomes, use neat_forward() for execution"
      },
      "backend_run_model": {
        "id": "1.13",
        "name": "Run Model Columns",
        "status": "pending",
        "file": "backend/app/models/run.py",
        "new_file": false,
        "description": "Add innovation_counter_connection and innovation_counter_node columns"
      },
      "backend_migration": {
        "id": "1.14",
        "name": "Database Migration",
        "status": "pending",
        "file": "backend/migrations/006_add_neat_columns.py",
        "new_file": true,
        "description": "Migration for innovation counter columns"
      },
      "backend_api": {
        "id": "1.15",
        "name": "API Changes",
        "status": "pending",
        "file": "backend/app/api/evolution.py",
        "new_file": false,
        "description": "Accept NEAT config, return innovation counter state in response"
      },
      "backend_tests": {
        "id": "1.16",
        "name": "Backend Tests",
        "status": "pending",
        "files": [
          "backend/app/neural/test_neat_network.py",
          "backend/app/genetics/test_neat_mutation.py",
          "backend/app/genetics/test_neat_crossover.py",
          "backend/app/genetics/test_neat_distance.py",
          "backend/app/genetics/test_neat_integration.py"
        ],
        "new_file": true,
        "description": "Tests for forward pass, mutations, crossover, distance, end-to-end"
      },
      "frontend_types": {
        "id": "1.17",
        "name": "TypeScript Types",
        "status": "pending",
        "file": "src/types/simulation.ts",
        "new_file": false,
        "description": "Add NEAT config fields and NEATGenome interface",
        "fields": [
          "useNEAT: boolean",
          "addConnectionRate: number",
          "addNodeRate: number",
          "neatExcessCoefficient: number",
          "neatDisjointCoefficient: number",
          "neatWeightCoefficient: number",
          "maxHiddenNodes: number"
        ]
      },
      "frontend_neural_panel": {
        "id": "1.18",
        "name": "Neural Panel UI",
        "status": "pending",
        "file": "app/components/menu/NeuralPanel.tsx",
        "new_file": false,
        "description": "Add NEAT toggle, show NEAT settings when enabled, hide fixed hidden size"
      },
      "frontend_visualizer": {
        "id": "1.19",
        "name": "Neural Visualizer",
        "status": "pending",
        "file": "src/ui/NeuralVisualizer.ts",
        "new_file": false,
        "description": "Handle variable topology: layout by depth, skip connections, disabled as dashed"
      },
      "frontend_stats": {
        "id": "1.20",
        "name": "Stats Panel",
        "status": "pending",
        "file": "app/components/grid/StatsPanel.tsx",
        "new_file": false,
        "description": "Show avg hidden nodes, avg connections (species count from speciation)"
      },
      "frontend_storage": {
        "id": "1.21",
        "name": "Storage Service",
        "status": "pending",
        "file": "src/services/StorageService.ts",
        "new_file": false,
        "description": "Handle NEAT genome format in save/load"
      },
      "docs_neat": {
        "id": "1.22",
        "name": "NEAT Documentation",
        "status": "pending",
        "file": "docs/NEAT.md",
        "new_file": false,
        "description": "Update with final implementation details"
      },
      "docs_evolution": {
        "id": "1.23",
        "name": "Evolution Documentation",
        "status": "pending",
        "file": "docs/EVOLUTION.md",
        "new_file": false,
        "description": "Add NEAT section"
      }
    },
    "verification": {
      "unit_tests": [
        "NEAT genomes can be created with minimal topology",
        "Forward pass produces correct outputs",
        "Structural mutations add connections and nodes",
        "Innovation tracking prevents duplicate IDs",
        "NEAT crossover aligns genes correctly",
        "Speciation works with NEAT distance function"
      ],
      "integration_tests": [
        "UI toggle enables/disables NEAT",
        "Visualizer handles variable topology",
        "Creatures evolve increasing complexity over generations",
        "All tests pass",
        "Backward compatible (fixed topology still works)"
      ],
      "manual_testing": [
        "Create new run with NEAT enabled",
        "Run 50+ generations",
        "Verify hidden nodes appear over time",
        "Verify multiple species form",
        "Verify fitness improves",
        "Verify no crashes or NaN values",
        "Compare evolution speed vs fixed topology"
      ]
    }
  },
  "phase_2": {
    "name": "Recurrent NEAT",
    "status": "future",
    "goal": "Allow recurrent connections for temporal memory",
    "prerequisite": "Phase 1 must be proven stable first",
    "tasks": {
      "config": {
        "id": "2.1",
        "name": "Recurrent Config",
        "status": "pending",
        "description": "Add allow_recurrent: bool config option"
      },
      "mutation_update": {
        "id": "2.2",
        "name": "Allow Cycles",
        "status": "pending",
        "file": "backend/app/genetics/neat_mutation.py",
        "description": "Update mutate_add_connection() to allow cycles when enabled"
      },
      "recurrent_forward": {
        "id": "2.3",
        "name": "Recurrent Forward Pass",
        "status": "pending",
        "file": "backend/app/neural/neat_network.py",
        "description": "Track activations from previous timestep, process in fixed order"
      },
      "cycle_detection": {
        "id": "2.4",
        "name": "Conditional Cycle Detection",
        "status": "pending",
        "description": "Update would_create_cycle() to be conditional on allow_recurrent"
      },
      "tests": {
        "id": "2.5",
        "name": "Recurrent Tests",
        "status": "pending",
        "description": "Add tests for recurrent networks"
      },
      "docs": {
        "id": "2.6",
        "name": "Documentation",
        "status": "pending",
        "description": "Document recurrent behavior"
      }
    },
    "design_considerations": [
      "Recurrent connections need activation memory per creature",
      "Execution order matters (can't use topological sort)",
      "May need multiple forward passes per timestep for deep recurrence",
      "Consider limiting recurrence depth"
    ]
  },
  "config_defaults": {
    "use_neat": false,
    "add_connection_rate": 0.05,
    "add_node_rate": 0.03,
    "enable_connection_rate": 0.02,
    "disable_connection_rate": 0.01,
    "weight_mutate_rate": 0.8,
    "weight_perturb_rate": 0.9,
    "weight_perturb_magnitude": 0.2,
    "neat_excess_coefficient": 1,
    "neat_disjoint_coefficient": 1,
    "neat_weight_coefficient": 0.4,
    "max_hidden_nodes": 16,
    "max_connections": 128
  },
  "references": {
    "neat_paper": "https://nn.cs.utexas.edu/downloads/papers/stanley.ec02.pdf",
    "neat_python": "https://neat-python.readthedocs.io/",
    "mari_o": "https://www.youtube.com/watch?v=qv6UVOQ0F44"
  }
}
