{
  "version": "2.0",
  "name": "Backend Migration PRD - PyTorch First",
  "description": "PyTorch-first migration prioritizing GPU-ready physics simulation",
  "goals": [
    "Batched physics simulation in PyTorch (CPU/GPU agnostic)",
    "100+ creatures simulated in <1 second on CPU",
    "1000+ creatures in <1 second on A100 GPU",
    "Full feature parity with TypeScript frontend"
  ],
  "phases": [
    {
      "id": 1,
      "name": "PyTorch Physics Core",
      "status": "completed",
      "priority": "CRITICAL",
      "description": "Batched spring physics simulation in PyTorch tensors - the foundation for everything",
      "items": [
        {
          "id": "1.1",
          "name": "Create tensor data structures",
          "status": "completed",
          "details": "Design batched tensors for creatures: positions [B, max_nodes, 3], velocities [B, max_nodes, 3], masses [B, max_nodes], node_mask [B, max_nodes], spring connections [B, max_muscles, 2], spring params [B, max_muscles, 6]"
        },
        {
          "id": "1.2",
          "name": "Implement batched spring forces",
          "status": "completed",
          "details": "Vectorized spring force calculation: F = -k(|x_b - x_a| - rest_length) * direction. Handle variable rest lengths for oscillation."
        },
        {
          "id": "1.3",
          "name": "Implement gravity and ground collision",
          "status": "completed",
          "details": "Batched gravity (simple), ground collision with friction and restitution. All creatures processed in parallel."
        },
        {
          "id": "1.4",
          "name": "Implement muscle oscillation",
          "status": "completed",
          "details": "Time-varying rest length: rest_length * (1 - amplitude * sin(freq * t + phase)). Batch across all muscles of all creatures."
        },
        {
          "id": "1.5",
          "name": "Implement physics integration loop",
          "status": "completed",
          "details": "Euler or Verlet integration. Run N timesteps, accumulate forces, update positions/velocities. Single kernel call per timestep."
        },
        {
          "id": "1.6",
          "name": "Add pellet collision detection",
          "status": "completed",
          "details": "Batched distance check between creature COMs and pellets. Track collection per creature."
        },
        {
          "id": "1.7",
          "name": "Implement fitness calculation",
          "status": "completed",
          "details": "Batched fitness: pellet points + progress + net displacement + distance traveled - penalties. All configurable weights."
        },
        {
          "id": "1.8",
          "name": "Add disqualification detection",
          "status": "completed",
          "details": "Detect NaN positions, physics explosions (position > threshold), frequency violations. Mark creatures as disqualified."
        }
      ]
    },
    {
      "id": 2,
      "name": "PyTorch Neural Network",
      "status": "completed",
      "priority": "HIGH",
      "description": "Batched neural network forward pass for creature control",
      "items": [
        {
          "id": "2.1",
          "name": "Create batched NN architecture",
          "status": "completed",
          "details": "BatchedNeuralNetwork class using einsum for batched forward pass. Each creature has own weights stored as tensors. Supports tanh/relu/sigmoid activations."
        },
        {
          "id": "2.2",
          "name": "Implement sensor input gathering",
          "status": "completed",
          "details": "Batched computation of pellet_direction, velocity, distance. Pure mode (7 inputs) vs hybrid mode (8 inputs with time phase). gather_sensor_inputs function."
        },
        {
          "id": "2.3",
          "name": "Integrate NN with physics loop",
          "status": "completed",
          "details": "simulate_with_neural function integrates NN with physics. Pure mode: NN controls directly (contraction = nn_output * amplitude). Hybrid: NN modulates oscillator (nn_modulation = 0.5 + (nn_output + 1) * 0.5)."
        },
        {
          "id": "2.4",
          "name": "Add efficiency penalty tracking",
          "status": "completed",
          "details": "physics_step_neural returns total_activation = sum(|nn_output|) for valid muscles. Accumulated over simulation for efficiency penalty."
        }
      ]
    },
    {
      "id": 3,
      "name": "Validation Against TypeScript",
      "status": "completed",
      "priority": "HIGH",
      "description": "Ensure PyTorch physics matches TypeScript Cannon-ES behavior",
      "items": [
        {
          "id": "3.1",
          "name": "Create test genome fixtures",
          "status": "completed",
          "details": "Created 9 test genomes covering oscillator, neural hybrid, neural pure, edge cases. Saved to fixtures/test_genomes.json."
        },
        {
          "id": "3.2",
          "name": "Run same genomes in PyTorch",
          "status": "completed",
          "details": "26 validation tests passing - physics, neural integration, edge cases, fitness, batching."
        },
        {
          "id": "3.3",
          "name": "Tune physics parameters",
          "status": "completed",
          "details": "Physics constants verified: gravity=-9.8, timestep=1/60, damping=0.1, restitution=0.2. Mass formula matches TypeScript."
        },
        {
          "id": "3.4",
          "name": "Benchmark CPU performance",
          "status": "completed",
          "details": "100 creatures in <1s, 500 creatures in <5s. Performance targets met."
        }
      ]
    },
    {
      "id": 4,
      "name": "API Integration",
      "status": "completed",
      "priority": "CRITICAL",
      "description": "Wire PyTorch physics to API endpoints - now connected",
      "items": [
        {
          "id": "4.1",
          "name": "Expand API schemas",
          "status": "completed",
          "details": "Updated app/schemas/simulation.py with ~35 config fields and FitnessBreakdown in SimulationResult. Updated app/schemas/genome.py with neural genome and v1/v2 muscle fields."
        },
        {
          "id": "4.2",
          "name": "Create PyTorchSimulator service",
          "status": "completed",
          "details": "Created app/services/pytorch_simulator.py that uses creature_genomes_to_batch, simulate_with_pellets/simulate_with_neural, and returns results in API format."
        },
        {
          "id": "4.3",
          "name": "Wire SimulatorService to PyTorch",
          "status": "completed",
          "details": "Replaced NumPy ProcessPoolExecutor in app/services/simulator.py with batched PyTorch call via PyTorchSimulator."
        },
        {
          "id": "4.4",
          "name": "Add neural network mode to API",
          "status": "completed",
          "details": "Exposed use_neural_net, neural_mode, neural_hidden_size in SimulationConfig. NeuralGenome supported in CreatureGenome schema."
        },
        {
          "id": "4.5",
          "name": "Add frame recording support",
          "status": "completed",
          "details": "record_frames flag in config. Frames returned as list of positions (quaternions can be added later if needed)."
        },
        {
          "id": "4.6",
          "name": "Add API integration tests",
          "status": "completed",
          "details": "Created app/api/test_simulation_api.py with 6 tests covering basic simulation, batch, fitness breakdown, defaults, disqualification, and performance."
        }
      ]
    },
    {
      "id": 5,
      "name": "Genetics in Python",
      "status": "completed",
      "priority": "MEDIUM",
      "description": "Selection, crossover, mutation in pure Python (not GPU-bound)",
      "items": [
        {
          "id": "5.1",
          "name": "Port Selection",
          "status": "completed",
          "details": "Implemented truncation_selection, tournament_selection, get_elites, rank_based_probabilities, weighted_random_select in app/genetics/selection.py"
        },
        {
          "id": "5.2",
          "name": "Port Mutation",
          "status": "completed",
          "details": "Implemented mutate_genome, mutate_node, mutate_muscle, add_node, remove_node, add_muscle, mutate_neural_weights in app/genetics/mutation.py"
        },
        {
          "id": "5.3",
          "name": "Port Crossover",
          "status": "completed",
          "details": "Implemented single_point_crossover, uniform_crossover, clone_genome, crossover_neural_weights, adapt_neural_topology in app/genetics/crossover.py"
        },
        {
          "id": "5.4",
          "name": "Population management",
          "status": "completed",
          "details": "Implemented generate_random_genome, generate_population, evolve_population, calculate_decayed_rate in app/genetics/population.py"
        },
        {
          "id": "5.5",
          "name": "API endpoints",
          "status": "completed",
          "details": "Created /api/genetics/generate and /api/genetics/evolve endpoints in app/api/genetics.py. 40 unit tests in test_genetics.py."
        }
      ]
    },
    {
      "id": 5,
      "name": "API Schemas & Database",
      "status": "pending",
      "priority": "MEDIUM",
      "description": "Pydantic schemas and PostgreSQL models",
      "items": [
        {
          "id": "5.1",
          "name": "Update Pydantic schemas",
          "status": "pending",
          "details": "Full CreatureGenome with neural, muscle v1/v2 fields. SimulationConfig with all fitness weights. Match TypeScript exactly."
        },
        {
          "id": "5.2",
          "name": "Update SQLAlchemy models",
          "status": "pending",
          "details": "Run, Generation, Creature, CreatureFrame models. JSON columns for genome, config."
        },
        {
          "id": "5.3",
          "name": "Create Alembic migration",
          "status": "pending",
          "details": "Migration from initial schema to full schema."
        },
        {
          "id": "5.4",
          "name": "Implement frame compaction",
          "status": "pending",
          "details": "Compact/expand frame format matching TypeScript. Selective storage (top 10 + random 10 + bottom 5)."
        }
      ]
    },
    {
      "id": 6,
      "name": "API Endpoints",
      "status": "pending",
      "priority": "MEDIUM",
      "description": "FastAPI routes for frontend integration",
      "items": [
        {
          "id": "6.1",
          "name": "Run CRUD endpoints",
          "status": "pending",
          "details": "Create, read, update, delete runs. Fork run."
        },
        {
          "id": "6.2",
          "name": "Generation endpoints",
          "status": "pending",
          "details": "List generations, get generation with creatures, fitness history, creature type history."
        },
        {
          "id": "6.3",
          "name": "Evolution endpoints",
          "status": "pending",
          "details": "POST /evolve/step (one generation), POST /evolve/batch (N generations), WebSocket for progress."
        },
        {
          "id": "6.4",
          "name": "Creature endpoints",
          "status": "pending",
          "details": "Get creature with frames, best creature, longest survivor."
        }
      ]
    },
    {
      "id": 7,
      "name": "Integration Testing",
      "status": "pending",
      "priority": "HIGH",
      "description": "Comprehensive tests before frontend integration",
      "items": [
        {
          "id": "7.1",
          "name": "Physics unit tests",
          "status": "pending",
          "details": "Test spring forces, gravity, collision, oscillation independently."
        },
        {
          "id": "7.2",
          "name": "Genetics unit tests",
          "status": "pending",
          "details": "Test selection, mutation, crossover produce valid genomes."
        },
        {
          "id": "7.3",
          "name": "API integration tests",
          "status": "pending",
          "details": "Full flow: create run → evolve → load history → get creatures."
        },
        {
          "id": "7.4",
          "name": "Run claude-critic review",
          "status": "pending",
          "details": "Spawn critic agent to find misalignment, edge cases, security issues."
        }
      ]
    },
    {
      "id": 8,
      "name": "Frontend Integration",
      "status": "pending",
      "priority": "MEDIUM",
      "description": "Connect React/Next.js frontend to Python backend",
      "items": [
        {
          "id": "8.1",
          "name": "Create TypeScript API client",
          "status": "pending",
          "details": "Typed fetch wrapper for all backend endpoints."
        },
        {
          "id": "8.2",
          "name": "Update StorageService",
          "status": "pending",
          "details": "Replace IndexedDB with API calls."
        },
        {
          "id": "8.3",
          "name": "Update SimulationService",
          "status": "pending",
          "details": "Call backend for simulation instead of local Cannon-ES."
        },
        {
          "id": "8.4",
          "name": "Add WebSocket for live updates",
          "status": "pending",
          "details": "Real-time generation progress during evolution."
        },
        {
          "id": "8.5",
          "name": "Handle offline/reconnection",
          "status": "pending",
          "details": "Graceful degradation, connection status UI."
        }
      ]
    },
    {
      "id": 9,
      "name": "GPU Optimization",
      "status": "pending",
      "priority": "LOW",
      "description": "Optimize for A100 deployment",
      "items": [
        {
          "id": "9.1",
          "name": "Profile GPU memory usage",
          "status": "pending",
          "details": "Ensure batches fit in GPU memory. May need to chunk large populations."
        },
        {
          "id": "9.2",
          "name": "Optimize tensor operations",
          "status": "pending",
          "details": "Minimize CPU-GPU transfers, use in-place operations where possible."
        },
        {
          "id": "9.3",
          "name": "Benchmark GPU vs CPU",
          "status": "pending",
          "details": "Document speedup for various population sizes."
        },
        {
          "id": "9.4",
          "name": "Add mixed precision",
          "status": "pending",
          "details": "Use float16 where accuracy permits for 2x memory/speed improvement."
        }
      ]
    },
    {
      "id": 10,
      "name": "Documentation & Deployment",
      "status": "pending",
      "priority": "LOW",
      "description": "Final docs and deployment prep",
      "items": [
        {
          "id": "10.1",
          "name": "Update backend README",
          "status": "pending",
          "details": "Setup, API docs, deployment guide."
        },
        {
          "id": "10.2",
          "name": "Update CLAUDE.md",
          "status": "pending",
          "details": "Backend commands, architecture notes."
        },
        {
          "id": "10.3",
          "name": "Create Dockerfile",
          "status": "pending",
          "details": "Container with PyTorch + CUDA support."
        },
        {
          "id": "10.4",
          "name": "Update CHANGELOG",
          "status": "pending",
          "details": "Document backend migration."
        }
      ]
    }
  ],
  "current_phase": 5,
  "current_item": "5.5",
  "notes": {
    "physics_approach": "Custom spring physics in PyTorch tensors. Not using PyBullet because we need batched simulation across 1000+ creatures, which requires custom tensor ops.",
    "cpu_gpu_agnostic": "All code uses torch tensors. Device selection at runtime: cuda if available, else cpu. Same code path.",
    "why_not_pybullet": "PyBullet simulates one world at a time. We need to simulate 1000 creatures in parallel. Custom tensor physics allows this.",
    "accuracy_tradeoff": "Our spring physics won't be identical to Cannon-ES, but for evolution it doesn't matter - creatures will adapt to whatever physics we use."
  }
}
