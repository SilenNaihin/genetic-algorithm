{
  "version": "2.0",
  "name": "Backend Migration PRD - PyTorch First",
  "description": "PyTorch-first migration prioritizing GPU-ready physics simulation",
  "goals": [
    "Batched physics simulation in PyTorch (CPU/GPU agnostic)",
    "100+ creatures simulated in <1 second on CPU",
    "1000+ creatures in <1 second on A100 GPU",
    "Full feature parity with TypeScript frontend"
  ],
  "phases": [
    {
      "id": 1,
      "name": "PyTorch Physics Core",
      "status": "pending",
      "priority": "CRITICAL",
      "description": "Batched spring physics simulation in PyTorch tensors - the foundation for everything",
      "items": [
        {
          "id": "1.1",
          "name": "Create tensor data structures",
          "status": "completed",
          "details": "Design batched tensors for creatures: positions [B, max_nodes, 3], velocities [B, max_nodes, 3], masses [B, max_nodes], node_mask [B, max_nodes], spring connections [B, max_muscles, 2], spring params [B, max_muscles, 6]"
        },
        {
          "id": "1.2",
          "name": "Implement batched spring forces",
          "status": "pending",
          "details": "Vectorized spring force calculation: F = -k(|x_b - x_a| - rest_length) * direction. Handle variable rest lengths for oscillation."
        },
        {
          "id": "1.3",
          "name": "Implement gravity and ground collision",
          "status": "pending",
          "details": "Batched gravity (simple), ground collision with friction and restitution. All creatures processed in parallel."
        },
        {
          "id": "1.4",
          "name": "Implement muscle oscillation",
          "status": "pending",
          "details": "Time-varying rest length: rest_length * (1 - amplitude * sin(freq * t + phase)). Batch across all muscles of all creatures."
        },
        {
          "id": "1.5",
          "name": "Implement physics integration loop",
          "status": "pending",
          "details": "Euler or Verlet integration. Run N timesteps, accumulate forces, update positions/velocities. Single kernel call per timestep."
        },
        {
          "id": "1.6",
          "name": "Add pellet collision detection",
          "status": "pending",
          "details": "Batched distance check between creature COMs and pellets. Track collection per creature."
        },
        {
          "id": "1.7",
          "name": "Implement fitness calculation",
          "status": "pending",
          "details": "Batched fitness: pellet points + progress + net displacement + distance traveled - penalties. All configurable weights."
        },
        {
          "id": "1.8",
          "name": "Add disqualification detection",
          "status": "pending",
          "details": "Detect NaN positions, physics explosions (position > threshold), frequency violations. Mark creatures as disqualified."
        }
      ]
    },
    {
      "id": 2,
      "name": "PyTorch Neural Network",
      "status": "pending",
      "priority": "HIGH",
      "description": "Batched neural network forward pass for creature control",
      "items": [
        {
          "id": "2.1",
          "name": "Create batched NN architecture",
          "status": "pending",
          "details": "torch.nn.Module with Linear layers. Input: [B, num_muscles, input_size], Output: [B, num_muscles]. Batch across all creatures AND all muscles."
        },
        {
          "id": "2.2",
          "name": "Implement sensor input gathering",
          "status": "pending",
          "details": "Batched computation of pellet_direction, velocity, distance for all creatures. Pure mode (7 inputs) vs hybrid mode (8 inputs with time phase)."
        },
        {
          "id": "2.3",
          "name": "Integrate NN with physics loop",
          "status": "pending",
          "details": "Each timestep: gather sensors → NN forward → muscle activations → spring forces. Pure mode: NN controls directly. Hybrid: NN modulates oscillator."
        },
        {
          "id": "2.4",
          "name": "Add efficiency penalty tracking",
          "status": "pending",
          "details": "Track total muscle activation per creature for efficiency penalty in fitness."
        }
      ]
    },
    {
      "id": 3,
      "name": "Validation Against TypeScript",
      "status": "pending",
      "priority": "HIGH",
      "description": "Ensure PyTorch physics matches TypeScript Cannon-ES behavior",
      "items": [
        {
          "id": "3.1",
          "name": "Create test genome fixtures",
          "status": "pending",
          "details": "Export 5-10 genomes from TypeScript with known fitness results. Save as JSON fixtures."
        },
        {
          "id": "3.2",
          "name": "Run same genomes in PyTorch",
          "status": "pending",
          "details": "Simulate fixtures in PyTorch, compare fitness within tolerance (physics won't be identical, but should be close)."
        },
        {
          "id": "3.3",
          "name": "Tune physics parameters",
          "status": "pending",
          "details": "Adjust damping, ground friction, spring stiffness until PyTorch creatures behave similarly to Cannon-ES."
        },
        {
          "id": "3.4",
          "name": "Benchmark CPU performance",
          "status": "pending",
          "details": "Time simulation of 100, 500, 1000 creatures. Target: <1s for 100 on CPU."
        }
      ]
    },
    {
      "id": 4,
      "name": "Genetics in PyTorch",
      "status": "pending",
      "priority": "MEDIUM",
      "description": "Selection, crossover, mutation - can stay NumPy/Python (not GPU-bound)",
      "items": [
        {
          "id": "4.1",
          "name": "Port Selection",
          "status": "pending",
          "details": "Rank-based selection, tournament selection, elitism. Python is fine here - not the bottleneck."
        },
        {
          "id": "4.2",
          "name": "Port Mutation",
          "status": "pending",
          "details": "Parameter mutation, structural mutation (add/remove nodes/muscles), neural weight mutation."
        },
        {
          "id": "4.3",
          "name": "Port Crossover",
          "status": "pending",
          "details": "Node/muscle alignment, parameter blending, neural weight crossover."
        },
        {
          "id": "4.4",
          "name": "Implement genome-to-tensor conversion",
          "status": "pending",
          "details": "Convert list of CreatureGenome dicts to batched tensors for simulation. Convert back after."
        }
      ]
    },
    {
      "id": 5,
      "name": "API Schemas & Database",
      "status": "pending",
      "priority": "MEDIUM",
      "description": "Pydantic schemas and PostgreSQL models",
      "items": [
        {
          "id": "5.1",
          "name": "Update Pydantic schemas",
          "status": "pending",
          "details": "Full CreatureGenome with neural, muscle v1/v2 fields. SimulationConfig with all fitness weights. Match TypeScript exactly."
        },
        {
          "id": "5.2",
          "name": "Update SQLAlchemy models",
          "status": "pending",
          "details": "Run, Generation, Creature, CreatureFrame models. JSON columns for genome, config."
        },
        {
          "id": "5.3",
          "name": "Create Alembic migration",
          "status": "pending",
          "details": "Migration from initial schema to full schema."
        },
        {
          "id": "5.4",
          "name": "Implement frame compaction",
          "status": "pending",
          "details": "Compact/expand frame format matching TypeScript. Selective storage (top 10 + random 10 + bottom 5)."
        }
      ]
    },
    {
      "id": 6,
      "name": "API Endpoints",
      "status": "pending",
      "priority": "MEDIUM",
      "description": "FastAPI routes for frontend integration",
      "items": [
        {
          "id": "6.1",
          "name": "Run CRUD endpoints",
          "status": "pending",
          "details": "Create, read, update, delete runs. Fork run."
        },
        {
          "id": "6.2",
          "name": "Generation endpoints",
          "status": "pending",
          "details": "List generations, get generation with creatures, fitness history, creature type history."
        },
        {
          "id": "6.3",
          "name": "Evolution endpoints",
          "status": "pending",
          "details": "POST /evolve/step (one generation), POST /evolve/batch (N generations), WebSocket for progress."
        },
        {
          "id": "6.4",
          "name": "Creature endpoints",
          "status": "pending",
          "details": "Get creature with frames, best creature, longest survivor."
        }
      ]
    },
    {
      "id": 7,
      "name": "Integration Testing",
      "status": "pending",
      "priority": "HIGH",
      "description": "Comprehensive tests before frontend integration",
      "items": [
        {
          "id": "7.1",
          "name": "Physics unit tests",
          "status": "pending",
          "details": "Test spring forces, gravity, collision, oscillation independently."
        },
        {
          "id": "7.2",
          "name": "Genetics unit tests",
          "status": "pending",
          "details": "Test selection, mutation, crossover produce valid genomes."
        },
        {
          "id": "7.3",
          "name": "API integration tests",
          "status": "pending",
          "details": "Full flow: create run → evolve → load history → get creatures."
        },
        {
          "id": "7.4",
          "name": "Run claude-critic review",
          "status": "pending",
          "details": "Spawn critic agent to find misalignment, edge cases, security issues."
        }
      ]
    },
    {
      "id": 8,
      "name": "Frontend Integration",
      "status": "pending",
      "priority": "MEDIUM",
      "description": "Connect React/Next.js frontend to Python backend",
      "items": [
        {
          "id": "8.1",
          "name": "Create TypeScript API client",
          "status": "pending",
          "details": "Typed fetch wrapper for all backend endpoints."
        },
        {
          "id": "8.2",
          "name": "Update StorageService",
          "status": "pending",
          "details": "Replace IndexedDB with API calls."
        },
        {
          "id": "8.3",
          "name": "Update SimulationService",
          "status": "pending",
          "details": "Call backend for simulation instead of local Cannon-ES."
        },
        {
          "id": "8.4",
          "name": "Add WebSocket for live updates",
          "status": "pending",
          "details": "Real-time generation progress during evolution."
        },
        {
          "id": "8.5",
          "name": "Handle offline/reconnection",
          "status": "pending",
          "details": "Graceful degradation, connection status UI."
        }
      ]
    },
    {
      "id": 9,
      "name": "GPU Optimization",
      "status": "pending",
      "priority": "LOW",
      "description": "Optimize for A100 deployment",
      "items": [
        {
          "id": "9.1",
          "name": "Profile GPU memory usage",
          "status": "pending",
          "details": "Ensure batches fit in GPU memory. May need to chunk large populations."
        },
        {
          "id": "9.2",
          "name": "Optimize tensor operations",
          "status": "pending",
          "details": "Minimize CPU-GPU transfers, use in-place operations where possible."
        },
        {
          "id": "9.3",
          "name": "Benchmark GPU vs CPU",
          "status": "pending",
          "details": "Document speedup for various population sizes."
        },
        {
          "id": "9.4",
          "name": "Add mixed precision",
          "status": "pending",
          "details": "Use float16 where accuracy permits for 2x memory/speed improvement."
        }
      ]
    },
    {
      "id": 10,
      "name": "Documentation & Deployment",
      "status": "pending",
      "priority": "LOW",
      "description": "Final docs and deployment prep",
      "items": [
        {
          "id": "10.1",
          "name": "Update backend README",
          "status": "pending",
          "details": "Setup, API docs, deployment guide."
        },
        {
          "id": "10.2",
          "name": "Update CLAUDE.md",
          "status": "pending",
          "details": "Backend commands, architecture notes."
        },
        {
          "id": "10.3",
          "name": "Create Dockerfile",
          "status": "pending",
          "details": "Container with PyTorch + CUDA support."
        },
        {
          "id": "10.4",
          "name": "Update CHANGELOG",
          "status": "pending",
          "details": "Document backend migration."
        }
      ]
    }
  ],
  "current_phase": 1,
  "current_item": "1.2",
  "notes": {
    "physics_approach": "Custom spring physics in PyTorch tensors. Not using PyBullet because we need batched simulation across 1000+ creatures, which requires custom tensor ops.",
    "cpu_gpu_agnostic": "All code uses torch tensors. Device selection at runtime: cuda if available, else cpu. Same code path.",
    "why_not_pybullet": "PyBullet simulates one world at a time. We need to simulate 1000 creatures in parallel. Custom tensor physics allows this.",
    "accuracy_tradeoff": "Our spring physics won't be identical to Cannon-ES, but for evolution it doesn't matter - creatures will adapt to whatever physics we use."
  }
}
