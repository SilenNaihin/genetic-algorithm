{
  "name": "Neural Architecture Search CLI",
  "description": "Pure CLI for hyperparameter optimization and neural architecture search for Evolution Lab",
  "version": "0.2.0",
  "status": "in_progress",
  "created": "2025-01-25",
  "updated": "2025-01-29",
  "architecture": {
    "execution_model": "In-memory evolution (no per-generation DB writes)",
    "rationale": "~10x speedup by skipping creature records, frame compression, ORM commits",
    "data_tracked_per_run": [
      "Config (JSON blob)",
      "Fitness curve ([gen, best, avg, median] per generation)",
      "Final stats (best fitness, generations to plateau)",
      "Best genome (for verification replay)"
    ],
    "output": {
      "console": "Real-time progress per generation",
      "json": "Incremental writes to nas/results/<config>_<timestamp>.json (crash-safe)",
      "database": "Optional - only for winners we want to replay on frontend"
    }
  },
  "phases": [
    {
      "id": "phase-1",
      "name": "Fast CLI (V1)",
      "status": "completed",
      "description": "Minimal CLI for running evolution without database overhead. Focus on speed.",
      "tasks": [
        {
          "id": "1.1",
          "name": "In-memory runner",
          "description": "Evolution loop using PyTorchSimulator + genetics directly. No DB writes during run. Track [gen, best, avg, median] per generation.",
          "status": "completed",
          "file": "runner.py"
        },
        {
          "id": "1.2",
          "name": "Results persistence",
          "description": "Write fitness curves to JSON incrementally (crash-safe). Store config + per-gen stats + best genome.",
          "status": "completed",
          "file": "results_io.py"
        },
        {
          "id": "1.3",
          "name": "CLI run command",
          "description": "nas run --config <name> --generations N --seeds 3. Load config from /use-config system or inline params.",
          "status": "completed",
          "file": "cli.py"
        },
        {
          "id": "1.4",
          "name": "Console logging",
          "description": "Real-time progress: [seed 1/3] gen 25/100 | best: 342.5 | avg: 156.2 | 1.2s/gen",
          "status": "completed",
          "file": "cli.py"
        },
        {
          "id": "1.5",
          "name": "Speed validation",
          "description": "Target: 1000 creatures x 100 gens in <5 min on T4 GPU",
          "status": "completed",
          "file": null,
          "notes": "Pure mode: ~130-160 creatures/s. NEAT mode: ~14-16 creatures/s (CPU-bound due to variable topology). Pure meets target, NEAT is slower due to sequential forward passes."
        }
      ]
    },
    {
      "id": "phase-2",
      "name": "Config Comparison (V1.1)",
      "status": "not_started",
      "description": "Compare multiple configs and create replay runs for winners",
      "tasks": [
        {
          "id": "2.1",
          "name": "Compare command",
          "description": "nas compare config1 config2 config3 - load results JSONs and show comparison table",
          "status": "completed",
          "file": "cli.py"
        },
        {
          "id": "2.2",
          "name": "Replay command",
          "description": "nas replay --config <winner> --generations N - create full DB run with frame storage for frontend viewing",
          "status": "not_started",
          "file": "cli.py"
        }
      ]
    },
    {
      "id": "phase-3",
      "name": "Optuna Integration (V2)",
      "status": "not_started",
      "description": "Automated hyperparameter search with Optuna",
      "tasks": [
        {
          "id": "3.1",
          "name": "Parameter space definition",
          "description": "Define searchable parameters with types, ranges for Optuna sampler",
          "status": "not_started",
          "file": "config.py"
        },
        {
          "id": "3.2",
          "name": "Optuna study management",
          "description": "Create/resume studies, configure NSGA-II sampler for multi-objective",
          "status": "not_started",
          "file": "search.py"
        },
        {
          "id": "3.3",
          "name": "Multi-seed evaluation",
          "description": "Run each config with 3-5 seeds, report mean +/- std",
          "status": "not_started",
          "file": "search.py"
        },
        {
          "id": "3.4",
          "name": "Pruning integration",
          "description": "MedianPruner to early-stop bad configs",
          "status": "not_started",
          "file": "search.py"
        }
      ]
    },
    {
      "id": "phase-4",
      "name": "Analysis (V2.1)",
      "status": "not_started",
      "description": "Sensitivity analysis and findings documentation",
      "tasks": [
        {
          "id": "4.1",
          "name": "fANOVA sensitivity",
          "description": "Rank parameter importance after search completes",
          "status": "not_started",
          "file": "analysis.py"
        },
        {
          "id": "4.2",
          "name": "Findings notebook",
          "description": "Document results: parameter importance, best configs, mode comparison, recommendations",
          "status": "not_started",
          "file": "nas-findings.ipynb"
        }
      ]
    }
  ],
  "focus": {
    "primary": "NEAT (variable topology)",
    "secondary": "Pure neural (fixed topology baseline)",
    "tertiary": "Hybrid (if time permits)"
  },
  "parameters": {
    "constant_do_not_optimize": {
      "description": "These stay fixed to ensure consistent objective function and physics",
      "params": [
        {"name": "gravity", "value": -9.8},
        {"name": "simulation_duration", "value": 40},
        {"name": "physics_fps", "value": 30},
        {"name": "damping", "value": "default"},
        {"name": "velocity_cap", "value": "default"},
        {"name": "max_extension", "value": "default"},
        {"name": "fitness_*", "value": "all defaults"},
        {"name": "neural_dead_zone", "value": 0.1},
        {"name": "ground_friction", "value": 0.5}
      ]
    },
    "tier_1_population_evolution": [
      {"name": "population_size", "type": "int", "range": [100, 1000], "default": 200},
      {"name": "elite_count", "type": "int", "range": [1, 20], "default": 5},
      {"name": "cull_percentage", "type": "float", "range": [0.3, 0.7], "default": 0.5},
      {"name": "mutation_rate", "type": "float", "range": [0.1, 0.5], "default": 0.3},
      {"name": "mutation_magnitude", "type": "float", "range": [0.1, 0.5], "default": 0.3},
      {"name": "weight_mutation_rate", "type": "float", "range": [0.1, 0.5], "default": 0.2},
      {"name": "weight_mutation_magnitude", "type": "float", "range": [0.1, 1.0], "default": 0.3},
      {"name": "crossover_rate", "type": "float", "range": [0.0, 0.8], "default": 0.5},
      {"name": "selection_method", "type": "categorical", "choices": ["truncation", "tournament", "rank", "speciation"], "default": "rank"},
      {"name": "tournament_size", "type": "int", "range": [2, 7], "default": 3, "condition": "selection_method=tournament"}
    ],
    "tier_2_neat_specific": [
      {"name": "neat_initial_connectivity", "type": "categorical", "choices": ["full", "sparse_inputs", "sparse_outputs", "none"], "default": "full"},
      {"name": "neat_add_connection_rate", "type": "float", "range": [0.0, 0.8], "default": 0.5},
      {"name": "neat_add_node_rate", "type": "float", "range": [0.0, 0.5], "default": 0.2},
      {"name": "neat_enable_rate", "type": "float", "range": [0.0, 0.1], "default": 0.02},
      {"name": "neat_disable_rate", "type": "float", "range": [0.0, 0.1], "default": 0.01},
      {"name": "neat_max_hidden_nodes", "type": "int", "range": [4, 32], "default": 16},
      {"name": "compatibility_threshold", "type": "float", "range": [0.5, 3.0], "default": 1.0},
      {"name": "neat_excess_coefficient", "type": "float", "range": [0.5, 2.0], "default": 1.0},
      {"name": "neat_disjoint_coefficient", "type": "float", "range": [0.5, 2.0], "default": 1.0},
      {"name": "neat_weight_coefficient", "type": "float", "range": [0.1, 1.0], "default": 0.4},
      {"name": "bias_mode", "type": "categorical", "choices": ["node", "bias_node"], "default": "bias_node"},
      {"name": "use_fitness_sharing", "type": "bool", "default": false},
      {"name": "sharing_radius", "type": "float", "range": [0.3, 1.0], "default": 0.5}
    ],
    "tier_3_body_constraints": [
      {"name": "min_nodes", "type": "int", "range": [3, 4], "default": 3},
      {"name": "max_nodes", "type": "int", "range": [5, 10], "default": 8},
      {"name": "max_muscles", "type": "int", "range": [10, 20], "default": 15}
    ],
    "tier_4_pure_hybrid_only": [
      {"name": "neural_hidden_size", "type": "int", "range": [4, 24], "default": 8},
      {"name": "neural_output_bias", "type": "float", "range": [-0.5, 0.0], "default": -0.1},
      {"name": "time_encoding", "type": "categorical", "choices": ["cyclic", "sin", "raw"], "default": "cyclic", "condition": "neural_mode=hybrid"},
      {"name": "use_proprioception", "type": "bool", "default": false}
    ]
  },
  "auto_enforcement_rules": {
    "neat_mode": {
      "trigger": "neural_mode == 'neat'",
      "enforced": {
        "selection_method": "speciation",
        "use_fitness_sharing": false
      },
      "defaults_if_unset": {
        "bias_mode": "bias_node"
      }
    },
    "speciation_selection": {
      "trigger": "selection_method == 'speciation'",
      "activates": ["compatibility_threshold", "min_species_size"]
    }
  },
  "objectives": [
    {
      "name": "fitness",
      "direction": "maximize",
      "description": "Top-5 average fitness after N generations",
      "primary": true
    },
    {
      "name": "diversity",
      "direction": "maximize",
      "description": "Behavioral/morphological variance in population",
      "primary": false
    }
  ],
  "compute": {
    "hardware": "2x NVIDIA T4 (16GB VRAM each), 56GB RAM",
    "target_speed": "1000 creatures x 100 gens in <5 min",
    "screening_trial": {"generations": 50, "creatures": 200, "seeds": 1},
    "full_trial": {"generations": 100, "creatures": 500, "seeds": 3}
  },
  "decisions": {
    "v1_architecture": {
      "execution": "In-memory evolution (no per-gen DB writes)",
      "persistence": "JSON files written incrementally (crash-safe)",
      "database": "Only for replay runs of winning configs"
    },
    "seeds_per_config": "3 for speed, 5 for final validation",
    "output": {
      "console": "Real-time per-generation progress",
      "json": "nas/results/<config>_<timestamp>.json"
    },
    "v2_optuna": {
      "framework": "Optuna with NSGA-II",
      "pruning": "MedianPruner",
      "sensitivity_method": "fANOVA"
    }
  },
  "search_strategies": {
    "fixed_topology_search": {
      "description": "Search pure/hybrid modes with fixed architecture",
      "filter": "neural_mode in ['pure', 'hybrid']",
      "focus_params": ["neural_hidden_size", "neural_activation", "time_encoding", "mutation_rate", "weight_mutation_magnitude"]
    },
    "neat_search": {
      "description": "Search NEAT mode with variable topology",
      "filter": "neural_mode == 'neat'",
      "focus_params": ["neat_initial_connectivity", "neat_add_connection_rate", "neat_add_node_rate", "compatibility_threshold", "neat_excess_coefficient"]
    },
    "full_search": {
      "description": "Compare all modes head-to-head",
      "filter": null,
      "focus_params": ["neural_mode", "mutation_rate", "population_size", "simulation_duration"]
    }
  },
  "resolved_decisions": [
    "In-memory evolution for speed (no per-gen DB writes)",
    "JSON persistence with incremental writes (crash-safe)",
    "3-5 seeds per config",
    "Console + JSON output",
    "Physics/fitness stay constant, only optimize evolution/neural/body params",
    "NEAT is primary focus"
  ],
  "open_questions": [
    "How to measure behavioral diversity?",
    "Multi-GPU: parallel trials or larger batches?",
    "Optimal batch size for T4 VRAM"
  ]
}
