{
  "name": "Genetics System Overhaul",
  "version": "1.1",
  "goal": "Implement comprehensive neuroevolution improvements to enable effective neural architecture search (NAS)",
  "end_state": "All GA parameters configurable via UI, API-first architecture ready for headless NAS, human-in-the-loop mid-run tweaking, and NEAT topology evolution",
  "phases": [
    {
      "id": 1,
      "name": "Output Bias Parameter",
      "status": "complete",
      "description": "Replace dead zone with configurable output bias in neural settings",
      "tasks": [
        "Add outputBias to SimulationConfig (range -2 to 0, default -0.5)",
        "Replace dead zone slider with output bias slider in neural panel",
        "Update NeuralNetwork.initialize() to use config.outputBias instead of hardcoded -1.5",
        "Update tooltip to explain output bias effect on muscle activation",
        "Remove dead zone code path from BatchSimulator"
      ],
      "files": [
        "src/types/simulation.ts",
        "src/neural/NeuralNetwork.ts",
        "src/main.ts",
        "src/simulation/BatchSimulator.ts"
      ],
      "test_focus": "Creatures should be more active with bias closer to 0"
    },
    {
      "id": 2,
      "name": "Mutation Decay Improvements",
      "status": "complete",
      "description": "Add configurable decay start, end, and duration parameters",
      "tasks": [
        "Add to SimulationConfig: mutationDecayStart (default 0.5), mutationDecayEnd (default 0.1), mutationDecayGenerations (default 100)",
        "Update calculateDecayedRate() to use these parameters",
        "Add UI controls in neural panel for all three parameters",
        "Update Neural Config display box to show current effective rate"
      ],
      "files": [
        "src/types/simulation.ts",
        "src/genetics/Population.ts",
        "src/main.ts"
      ],
      "test_focus": "Verify mutation rate changes correctly over generations"
    },
    {
      "id": 3,
      "name": "Selection Methods",
      "status": "complete",
      "description": "Add tournament selection as alternative to truncation",
      "tasks": [
        "Add selectionMethod: 'truncation' | 'tournament' | 'rank' to SimulationConfig",
        "Add tournamentSize parameter (default 3)",
        "Wire up existing tournamentSelection() in backend",
        "Update evolve_population() to use selected method",
        "Add UI dropdown with dynamic tooltips for each method"
      ],
      "files": [
        "src/types/simulation.ts",
        "src/genetics/Selection.ts",
        "src/genetics/Population.ts",
        "src/main.ts"
      ],
      "test_focus": "Tournament should maintain more diversity than truncation"
    },
    {
      "id": 4,
      "name": "Adaptive Mutation",
      "status": "complete",
      "description": "Auto-increase mutation when fitness stagnates, with stateful tracking",
      "tasks": [
        "Add useAdaptiveMutation, stagnationThreshold (20), adaptiveMutationBoost (2x), maxAdaptiveBoost (8x), improvementThreshold (5 pts) to config",
        "Add adaptive_boost_level and gens_since_boost_change columns to Run model",
        "Implement trimmed_mean() for outlier-robust averaging",
        "Implement three-way decision logic (stagnating/marginal/improving)",
        "Add cooldown period between boost changes",
        "Add UI controls with all parameters",
        "Create database migration 004",
        "Create docs/ADAPTIVE_MUTATION.md"
      ],
      "files": [
        "src/types/simulation.ts",
        "src/genetics/Population.ts",
        "src/main.ts"
      ],
      "test_focus": "Mutation rate should increase after N generations without improvement"
    },
    {
      "id": 5,
      "name": "Crossover Improvements",
      "status": "complete",
      "description": "Add SBX crossover option for neural weights",
      "tasks": [
        "Add neuralCrossoverMethod: 'interpolation' | 'uniform' | 'sbx' to SimulationConfig",
        "Implement SBX crossover (Simulated Binary Crossover) with eta parameter",
        "Add eta parameter slider (default 2.0, range 0.5-5.0)",
        "Add UI dropdown for crossover method"
      ],
      "files": [
        "src/types/simulation.ts",
        "src/genetics/Crossover.ts",
        "src/main.ts"
      ],
      "test_focus": "SBX should produce offspring 'between' parents more smoothly"
    },
    {
      "id": 6,
      "name": "Fitness Sharing",
      "status": "complete",
      "description": "Implement fitness sharing for diversity maintenance",
      "tasks": [
        "Add useFitnessSharing: boolean to SimulationConfig",
        "Add sharingRadius parameter (default 0.5)",
        "Implement genomeDistance() for neural genomes",
        "Implement applyFitnessSharing() function",
        "Integrate into selection process",
        "Add UI toggle and radius slider"
      ],
      "files": [
        "src/types/simulation.ts",
        "src/genetics/Selection.ts",
        "src/genetics/Population.ts",
        "src/main.ts"
      ],
      "test_focus": "Population should maintain more phenotypic diversity"
    },
    {
      "id": 7,
      "name": "Proprioception Inputs",
      "status": "complete",
      "description": "Add body-sensing inputs to neural network (muscle strain, node velocities, ground contact)",
      "tasks": [
        "Add useProprioception: boolean to SimulationConfig",
        "Add proprioceptionInputs: 'strain' | 'velocity' | 'ground' | 'all' to SimulationConfig",
        "Calculate muscle strain inputs: (currentLength - restLength) / restLength per muscle",
        "Calculate node velocity inputs: normalized velocity vector per node",
        "Calculate ground contact inputs: 1 if nodeY < threshold, 0 otherwise per node",
        "Update gatherSensorInputs to include selected proprioception inputs",
        "Update NEURAL_INPUT_SIZE dynamically: base + (M strains) + (N*3 velocities) + (N contacts)",
        "Handle topology adaptation when proprioception toggled",
        "Add UI toggle and input type selector"
      ],
      "files": [
        "src/types/simulation.ts",
        "backend/app/schemas/simulation.py",
        "backend/app/neural/sensors.py",
        "backend/app/neural/network.py",
        "backend/app/simulation/physics.py",
        "backend/app/services/pytorch_simulator.py",
        "app/components/menu/NeuralPanel.tsx",
        "app/components/ui/InfoTooltip.tsx"
      ],
      "test_focus": "With proprioception, creatures should develop smoother gaits and better balance"
    },
    {
      "id": 8,
      "name": "NEAT Foundation",
      "status": "pending",
      "description": "Implement NEAT gene representation and structural mutations",
      "see_also": "docs/NEAT.md",
      "tasks": [
        "Define ConnectionGene and NodeGene interfaces",
        "Implement global innovation counter",
        "Implement NEATGenome creation with minimal topology",
        "Implement NEATNetwork.fromGenome() with topological sort",
        "Implement mutateAddConnection()",
        "Implement mutateAddNode()",
        "Add NEAT crossover by gene alignment",
        "Integrate with speciation (Phase 9)"
      ],
      "files": [
        "src/neural/NEATGenome.ts (new)",
        "src/neural/NEATNetwork.ts (new)",
        "src/genetics/NEATMutation.ts (new)",
        "src/genetics/NEATCrossover.ts (new)"
      ],
      "test_focus": "NEAT networks should grow topology over generations"
    },
    {
      "id": 9,
      "name": "Energy System",
      "status": "pending",
      "description": "Add metabolic energy to prevent infinite spazzing and encourage efficient movement",
      "rationale": "Currently creatures can oscillate muscles endlessly without cost. This leads to spazzy, inefficient behavior. Real organisms expend energy when contracting muscles, creating evolutionary pressure for efficient locomotion.",
      "design": {
        "core_mechanic": "Creatures have an energy pool that depletes with muscle activity and regenerates slowly over time",
        "energy_cost_formula": "energy_cost = sum(|muscle_output| × stiffness × dt) - models work done by muscles",
        "regeneration": {
          "passive": "Small constant regeneration per timestep (e.g., 0.5 energy/s)",
          "pellet_bonus": "Collecting a pellet restores significant energy (e.g., +50 energy)",
          "rationale": "Pellets become actual 'food' - creates biological scavenging pressure"
        },
        "depletion_behavior": {
          "at_zero": "Muscle outputs forced to zero (creature becomes 'exhausted')",
          "not_disqualification": "Creature can recover if it regenerates energy",
          "alternative": "Soft exhaustion - outputs scaled by remaining energy percentage"
        },
        "starting_energy": {
          "option_a": "Fixed amount for all creatures (e.g., 100 units)",
          "option_b": "Proportional to body mass (larger creatures have more energy)",
          "option_c": "Evolvable parameter in genome (adds complexity)"
        }
      },
      "fitness_integration": {
        "options": [
          "Energy efficiency bonus: fitness += remaining_energy × efficiency_weight",
          "Energy spent penalty: fitness -= energy_spent × cost_weight",
          "No direct fitness impact - energy is purely a constraint",
          "Efficiency metric: final_fitness = base_fitness × (energy_remaining / starting_energy)"
        ],
        "recommended": "Energy efficiency bonus - rewards creatures that accomplish goals with energy to spare"
      },
      "tasks": [
        "Add useEnergy: boolean to SimulationConfig (default: false)",
        "Add startingEnergy parameter (default: 100)",
        "Add energyRegenRate parameter (default: 0.5 per second)",
        "Add pelletEnergyBonus parameter (default: 50)",
        "Add energyCostScale parameter (default: 1.0) - multiplier for muscle energy cost",
        "Add energyEfficiencyBonus parameter (default: 0.2) - fitness points per remaining energy",
        "Track energy per creature in simulation state",
        "Implement energy cost calculation in physics step",
        "Implement passive regeneration",
        "Implement pellet energy restoration",
        "Implement exhaustion behavior (zero energy = zero muscle output)",
        "Add energy bar visualization in creature tooltip",
        "Add energy over time graph in replay modal",
        "Add UI controls in fitness/physics panel"
      ],
      "files": [
        "src/types/simulation.ts",
        "backend/app/schemas/simulation.py",
        "backend/app/simulation/config.py",
        "backend/app/simulation/physics.py",
        "backend/app/simulation/fitness.py",
        "backend/app/services/pytorch_simulator.py",
        "app/components/menu/PhysicsPanel.tsx or FitnessPanel.tsx",
        "app/components/grid/CreatureTooltip.tsx",
        "app/components/modals/ReplayModal.tsx"
      ],
      "test_focus": "Creatures should evolve smoother, more efficient gaits. Spazzy creatures should run out of energy quickly.",
      "edge_cases": [
        "Creature with zero energy at start (invalid config)",
        "Very high energy cost scale making all movement impossible",
        "Pellet energy bonus larger than starting energy",
        "Energy regeneration faster than consumption (negates the feature)",
        "Negative energy (should clamp to 0)"
      ],
      "references": [
        "Metabolic cost of transport in animals: https://en.wikipedia.org/wiki/Metabolic_cost_of_transport",
        "OpenAI Roboschool uses energy penalties for locomotion"
      ]
    },
    {
      "id": 10,
      "name": "Speciation (Basic)",
      "status": "pending",
      "description": "Implement basic speciation for diversity protection",
      "tasks": [
        "Define Species interface",
        "Add useSpeciation: boolean to SimulationConfig",
        "Add compatibilityThreshold parameter",
        "Implement species assignment based on genome distance",
        "Implement within-species selection",
        "Add species stagnation tracking and culling",
        "Visualize species count in stats panel"
      ],
      "files": [
        "src/types/simulation.ts",
        "src/genetics/Speciation.ts (new)",
        "src/genetics/Population.ts",
        "src/main.ts"
      ],
      "test_focus": "Multiple species should coexist with different strategies"
    },
    {
      "id": 11,
      "name": "Human-in-the-Loop Parameter Tweaking",
      "status": "pending",
      "description": "Allow mid-run parameter changes to guide evolution manually",
      "depends_on": "Phase 11 (API-First)",
      "tasks": [
        "Identify tweakable parameters: mutation rate, crossover rate, selection pressure, fitness weights",
        "Identify non-tweakable parameters: network topology, input size (require restart)",
        "Create ParameterChangeEvent with generation, parameter, oldValue, newValue",
        "Store parameter change history with run data",
        "Add 'Parameter History' timeline visualization",
        "Add mid-run parameter edit UI (sliders that apply immediately)",
        "Implement smooth parameter transitions (optional: ramp over N generations)",
        "Add 'revert to generation X config' functionality"
      ],
      "files": [
        "src/types/simulation.ts",
        "src/storage/RunStorage.ts",
        "src/main.ts",
        "src/ui/ParameterTimeline.ts (new)"
      ],
      "test_focus": "Parameter changes should take effect immediately and be tracked in history",
      "notes": "This enables 'playing god' - watching evolution and nudging parameters when stuck. Storage complexity: each run stores array of ParameterChangeEvents."
    }
  ],
  "mid_run_tweakable_params": {
    "description": "Parameters that can be changed during a run without restart",
    "tweakable": [
      "mutationRate",
      "mutationMagnitude",
      "crossoverRate",
      "selectionMethod",
      "tournamentSize",
      "cullPercentage",
      "fitnessWeights (pellet, progress, displacement, distance)",
      "efficiencyPenalty",
      "adaptiveMutationBoost",
      "sharingRadius"
    ],
    "not_tweakable": [
      "neuralMode (pure/hybrid) - changes input size",
      "hiddenSize - changes network topology",
      "proprioception toggle - changes input size",
      "populationSize - would require creating/culling creatures"
    ]
  },
  "documentation": {
    "files": [
      {
        "path": "CHANGELOG.md",
        "purpose": "Version history"
      },
      {
        "path": "CLAUDE.md",
        "purpose": "AI assistant context"
      },
      {
        "path": "docs/NEURAL.md",
        "purpose": "Neural network architecture and evolution"
      },
      {
        "path": "docs/GENOME.md",
        "purpose": "Genome structure and encoding"
      },
      {
        "path": "docs/NEAT.md",
        "purpose": "NEAT implementation plan"
      },
      {
        "path": "docs/optimized-runs.md",
        "purpose": "Parameter tuning results"
      }
    ],
    "update_after_each_phase": true
  },
  "references": {
    "neat_paper": "https://nn.cs.utexas.edu/downloads/papers/stanley.ec02.pdf",
    "sbx_crossover": "Deb & Agrawal (1995) - Simulated Binary Crossover",
    "tournament_selection": "Miller & Goldberg (1995) - Tournament Selection",
    "fitness_sharing": "Goldberg & Richardson (1987) - Genetic Algorithms with Sharing",
    "novelty_search": "Lehman & Stanley (2011) - Abandoning Objectives",
    "bayesian_optimization": "Snoek et al. (2012) - Practical Bayesian Optimization"
  },
  "guidelines": [
    "One phase at a time - test before moving on",
    "Update documentation after each phase",
    "Add tests for new genetics functions",
    "Keep UI changes minimal until Phase 10",
    "Maintain backward compatibility with existing saved runs",
    "GPU acceleration handled in separate chat"
  ],
  "if_we_plateau": {
    "description": "Lower-priority features to try if evolution stagnates. These add explicit selection pressure for behaviors already implicitly selected for, so may over-constrain the solution space.",
    "features": [
      {
        "name": "Time Bonus",
        "description": "Add time bonus for faster pellet collection",
        "rationale": "Breaks ties between creatures that collect same number of pellets. Adds continuous gradient to discrete pellet count.",
        "concern": "Already implicitly selected for - faster creatures collect MORE pellets in same time. May double-count same trait.",
        "tasks": [
          "Add fitnessTimeBonus parameter (default 20)",
          "Add fitnessTimeBonusScale (seconds for full bonus, default 5)",
          "Calculate time bonus: bonus * (1 - timeToCollect/scale)",
          "Update fitness calculation in backend",
          "Add UI controls"
        ]
      },
      {
        "name": "Efficiency Penalty Ramp",
        "description": "Make efficiency penalty ramp up over generations",
        "rationale": "Let creatures explore freely early, then penalize inefficiency later. Prevents premature convergence to efficient-but-bad solutions.",
        "concern": "Adds complexity. May be better to just run with no penalty initially and enable it manually if needed.",
        "tasks": [
          "Add efficiencyPenaltyStartGen (default 100)",
          "Add efficiencyPenaltyRampGens (default 100)",
          "Calculate effective penalty: 0 before startGen, linear ramp to full over rampGens",
          "Update fitness calculation in backend",
          "Add UI controls for start gen and ramp duration"
        ]
      },
      {
        "name": "Multi-Layer Hidden Networks",
        "description": "Add configurable number of hidden layers (currently fixed at 1)",
        "rationale": "With proprioception adding up to 56 inputs, deeper networks could learn hierarchical features (e.g., first layer extracts leg patterns, second combines into gaits).",
        "concern": "Neuroevolution struggles with deep networks - search space explodes without gradients. Width (more neurons) often helps more than depth for locomotion tasks. Current hidden size is only 8 - try increasing width first.",
        "recommendation": "Before adding layers, try: (1) hidden size 16 or 32, (2) longer evolution runs. If still stuck, try 2 hidden layers.",
        "tasks": [
          "Add hiddenLayers parameter (default 1, max 3)",
          "Add hiddenSizes array parameter (e.g., [16, 8] for 2 layers)",
          "Update BatchedNeuralNetwork to support variable depth",
          "Update weight mutation to handle multi-layer topology",
          "Update crossover for multi-layer genomes",
          "Update NeuralVisualizer to render multiple hidden layers",
          "Add UI controls for layer count and per-layer sizes"
        ],
        "weight_counts": {
          "1_layer_8_hidden": "~590 weights",
          "2_layers_8_8": "~655 weights",
          "1_layer_16_hidden": "~1135 weights",
          "2_layers_16_8": "~1200 weights"
        }
      }
    ]
  }
}
